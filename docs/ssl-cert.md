# 🔐 SSL Certificate Setup for SonarQube

A complete step-by-step guide to securing your SonarQube instance with SSL certificates using Let's Encrypt and NGINX.

---

## 🚀 Overview

This guide walks you through setting up SSL certificates for your SonarQube instance on AWS EC2 using:
- 🌐 **NGINX** as reverse proxy
- 🔒 **Let's Encrypt** for free SSL certificates
- ☁️ **AWS EC2** security group configuration
- 🔄 **Automatic HTTPS redirection**

---

## 📋 Prerequisites

Before starting, ensure you have:
- ✅ AWS EC2 instance running SonarQube
- ✅ Domain name pointing to your EC2 instance
- ✅ SSH access to your server
- ✅ Root or sudo privileges

---

## 🛠️ Step-by-Step Implementation

### 1️⃣ Install NGINX

First, install NGINX on your Ubuntu/Debian server:

```bash
# Update package list
sudo apt update

# Install NGINX
sudo apt install nginx -y

# Verify installation
sudo systemctl status nginx
```

### 2️⃣ Configure AWS Security Group

Open HTTPS traffic in your AWS Console:

1. 🔗 Navigate to **AWS Console → EC2 → Security Groups**
2. 📝 Select your instance's security group
3. ➕ **Edit Inbound Rules** and add:

| Type | Port | Source | Description |
|------|------|--------|-------------|
| **HTTPS** | 443 | 0.0.0.0/0 | SSL/TLS traffic |
| **HTTP** | 80 | 0.0.0.0/0 | HTTP traffic (for redirect) |

### 3️⃣ Install Certbot (Let's Encrypt)

Install the Let's Encrypt client and NGINX plugin:

```bash
# Install Certbot with NGINX plugin
sudo apt install certbot python3-certbot-nginx -y

# Verify installation
certbot --version
```

### 4️⃣ Configure NGINX for SonarQube

Create NGINX configuration for your SonarQube instance:

```bash
# Create NGINX config file
sudo nano /etc/nginx/sites-available/sonarqube
```

Add the following configuration (replace `sonarqube.yourdomain.com` with your actual domain):

```nginx
server {
    listen 80;
    server_name sonarqube.yourdomain.com;

    # Proxy all requests to SonarQube
    location / {
        proxy_pass http://localhost:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
    }

    # Optional: Health check endpoint
    location /status {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

Enable the configuration:

```bash
# Create symbolic link to enable site
sudo ln -s /etc/nginx/sites-available/sonarqube /etc/nginx/sites-enabled/

# Test NGINX configuration
sudo nginx -t

# Reload NGINX
sudo systemctl reload nginx
```

### 5️⃣ Obtain SSL Certificate

Use Certbot to automatically obtain and configure SSL:

```bash
# Obtain SSL certificate and configure NGINX
sudo certbot --nginx -d sonarqube.yourdomain.com

# Follow the interactive prompts:
# - Enter email address for notifications
# - Agree to terms of service
# - Choose whether to redirect HTTP to HTTPS (recommended: Yes)
```

> 🎉 **Success!** Certbot will automatically:
> - Generate SSL certificates
> - Update NGINX configuration
> - Set up automatic renewal

### 6️⃣ Configure HTTPS Redirect (Optional)

If Certbot didn't set up the redirect automatically, add this configuration:

```nginx
server {
    listen 80;
    server_name sonarqube.yourdomain.com;
    
    # Redirect all HTTP traffic to HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name sonarqube.yourdomain.com;
    
    # SSL configuration (auto-generated by Certbot)
    ssl_certificate /etc/letsencrypt/live/sonarqube.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/sonarqube.yourdomain.com/privkey.pem;
    
    # Modern SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    
    # HSTS header
    add_header Strict-Transport-Security "max-age=31536000" always;
    
    location / {
        proxy_pass http://localhost:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 7️⃣ Restart Services

Restart NGINX to apply all changes:

```bash
# Restart NGINX
sudo systemctl restart nginx

# Verify NGINX is running
sudo systemctl status nginx
```

### 8️⃣ Update SonarQube Configuration (Optional)

If SonarQube shows security warnings or redirect issues, update its configuration:

```bash
# Edit SonarQube properties
sudo nano /opt/sonarqube/conf/sonar.properties
```

Ensure these settings are configured:

```ini
# Web server configuration
sonar.web.context=
sonar.web.port=9000

# Optional: Set base URL for proper redirects
sonar.web.baseUrl=https://sonarqube.yourdomain.com
```

Restart SonarQube if you made changes:

```bash
# Restart SonarQube service
sudo systemctl restart sonarqube
```

---

## ✅ Verification & Testing

### Test Your SSL Setup

1. 🌐 **Visit your domain:** `https://sonarqube.yourdomain.com`
2. 🔒 **Check SSL certificate:** Look for the padlock icon in your browser
3. 🔄 **Test HTTP redirect:** Visit `http://sonarqube.yourdomain.com` and verify it redirects to HTTPS

### SSL Testing Tools

```bash
# Test SSL connection
openssl s_client -connect sonarqube.yourdomain.com:443

# Check certificate expiration
openssl x509 -in /etc/letsencrypt/live/sonarqube.yourdomain.com/fullchain.pem -text -noout | grep "Not After"
```

### Online SSL Testing

- 🔍 **SSL Labs Test:** `https://www.ssllabs.com/ssltest/`
- 📊 **Security Headers:** `https://securityheaders.com/`

---

## 🔄 Automatic Certificate Renewal

Let's Encrypt certificates expire every 90 days. Here's how to set up bulletproof automatic renewal:

### 🎯 Method 1: Systemd Timer (Recommended)

Certbot automatically installs a systemd timer on modern Linux distributions:

```bash
# Check if the timer is active
sudo systemctl status certbot.timer

# If not active, enable it
sudo systemctl enable certbot.timer
sudo systemctl start certbot.timer

# View timer schedule
sudo systemctl list-timers certbot.timer
```

### 🎯 Method 2: Cron Job Setup

For additional control, set up a custom cron job:

```bash
# Edit crontab for root
sudo crontab -e

# Add this line for daily renewal checks at 2:30 AM
30 2 * * * /usr/bin/certbot renew --quiet --nginx

# Alternative: Check twice daily at 2:30 AM and 2:30 PM
30 2,14 * * * /usr/bin/certbot renew --quiet --nginx
```

### 🎯 Method 3: Advanced Renewal Script

Create a comprehensive renewal script with logging and notifications:

```bash
# Create renewal script
sudo nano /usr/local/bin/certbot-renew.sh
```

Add this script content:

```bash
#!/bin/bash

# Advanced Certbot Renewal Script
# Created: $(date)

# Configuration
LOG_FILE="/var/log/certbot-renewal.log"
EMAIL="admin@yourdomain.com"
WEBHOOK_URL="https://your-slack-webhook-url.com"  # Optional

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Function to send notification (optional)
send_notification() {
    local message="$1"
    local status="$2"
    
    # Send email notification
    if command -v mail >/dev/null 2>&1; then
        echo "$message" | mail -s "SSL Certificate Renewal - $status" "$EMAIL"
    fi
    
    # Send Slack notification (if webhook configured)
    if [ -n "$WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"🔐 SSL Renewal - $status: $message\"}" \
            "$WEBHOOK_URL" >/dev/null 2>&1
    fi
}

# Start renewal process
log_message "Starting certificate renewal process..."

# Test renewal first
log_message "Testing renewal process..."
if sudo certbot renew --dry-run --quiet; then
    log_message "Dry run successful - proceeding with actual renewal"
else
    log_message "ERROR: Dry run failed - aborting renewal"
    send_notification "Certificate renewal dry run failed" "ERROR"
    exit 1
fi

# Perform actual renewal
log_message "Performing certificate renewal..."
RENEWAL_OUTPUT=$(sudo certbot renew --quiet --nginx 2>&1)
RENEWAL_EXIT_CODE=$?

if [ $RENEWAL_EXIT_CODE -eq 0 ]; then
    log_message "Certificate renewal completed successfully"
    
    # Check if certificates were actually renewed
    if echo "$RENEWAL_OUTPUT" | grep -q "renewed"; then
        log_message "Certificates were renewed - reloading services"
        
        # Reload NGINX
        if sudo systemctl reload nginx; then
            log_message "NGINX reloaded successfully"
        else
            log_message "ERROR: Failed to reload NGINX"
            send_notification "NGINX reload failed after certificate renewal" "WARNING"
        fi
        
        # Restart SonarQube if needed
        if sudo systemctl is-active sonarqube >/dev/null 2>&1; then
            log_message "Restarting SonarQube service..."
            sudo systemctl restart sonarqube
            log_message "SonarQube restarted successfully"
        fi
        
        send_notification "SSL certificates renewed successfully" "SUCCESS"
    else
        log_message "No certificates needed renewal"
    fi
else
    log_message "ERROR: Certificate renewal failed with exit code $RENEWAL_EXIT_CODE"
    log_message "Renewal output: $RENEWAL_OUTPUT"
    send_notification "Certificate renewal failed: $RENEWAL_OUTPUT" "ERROR"
    exit 1
fi

# Check certificate expiration dates
log_message "Checking certificate expiration dates..."
for cert in /etc/letsencrypt/live/*/fullchain.pem; do
    if [ -f "$cert" ]; then
        domain=$(basename "$(dirname "$cert")")
        expiry=$(openssl x509 -in "$cert" -noout -dates | grep "notAfter" | cut -d= -f2)
        log_message "Certificate for $domain expires: $expiry"
    fi
done

log_message "Certificate renewal process completed"
```

Make the script executable and set up permissions:

```bash
# Make script executable
sudo chmod +x /usr/local/bin/certbot-renew.sh

# Test the script
sudo /usr/local/bin/certbot-renew.sh

# Add to crontab
sudo crontab -e
```

Add this line to run the script daily at 3:00 AM:

```bash
0 3 * * * /usr/local/bin/certbot-renew.sh
```

### 🎯 Method 4: Renewal with Hooks

Set up renewal hooks for custom actions:

```bash
# Create pre-renewal hook
sudo mkdir -p /etc/letsencrypt/renewal-hooks/pre
sudo nano /etc/letsencrypt/renewal-hooks/pre/stop-services.sh
```

Pre-renewal hook content:

```bash
#!/bin/bash
# Stop services before renewal if needed
echo "$(date): Pre-renewal hook executed" >> /var/log/certbot-hooks.log
```

```bash
# Create post-renewal hook
sudo mkdir -p /etc/letsencrypt/renewal-hooks/post
sudo nano /etc/letsencrypt/renewal-hooks/post/reload-services.sh
```

Post-renewal hook content:

```bash
#!/bin/bash
# Reload services after successful renewal
echo "$(date): Post-renewal hook executed" >> /var/log/certbot-hooks.log

# Reload NGINX
systemctl reload nginx

# Restart SonarQube if running
if systemctl is-active sonarqube >/dev/null 2>&1; then
    systemctl restart sonarqube
fi

# Send notification
curl -X POST -H 'Content-type: application/json' \
    --data '{"text":"🔐 SSL certificates renewed and services reloaded successfully"}' \
    "$SLACK_WEBHOOK_URL" >/dev/null 2>&1 || true
```

Make hooks executable:

```bash
# Make hooks executable
sudo chmod +x /etc/letsencrypt/renewal-hooks/pre/stop-services.sh
sudo chmod +x /etc/letsencrypt/renewal-hooks/post/reload-services.sh
```

### 🔍 Monitoring Renewal Status

#### Check Renewal Timer Status

```bash
# View systemd timer details
sudo systemctl list-timers certbot.timer

# Check timer logs
sudo journalctl -u certbot.timer

# Check renewal service logs
sudo journalctl -u certbot.service
```

#### Manual Renewal Testing

```bash
# Test renewal process (dry run)
sudo certbot renew --dry-run

# Test with verbose output
sudo certbot renew --dry-run --verbose

# Force renewal (for testing only)
sudo certbot renew --force-renewal
```

#### Certificate Expiration Monitoring

```bash
# Check all certificate expiration dates
sudo certbot certificates

# Check specific domain expiration
openssl x509 -in /etc/letsencrypt/live/sonarqube.yourdomain.com/fullchain.pem -noout -dates

# Create a monitoring script
sudo nano /usr/local/bin/cert-monitor.sh
```

Certificate monitoring script:

```bash
#!/bin/bash

# Certificate expiration monitoring
THRESHOLD_DAYS=30
EMAIL="admin@yourdomain.com"

for cert in /etc/letsencrypt/live/*/fullchain.pem; do
    if [ -f "$cert" ]; then
        domain=$(basename "$(dirname "$cert")")
        expiry_date=$(openssl x509 -in "$cert" -noout -enddate | cut -d= -f2)
        expiry_epoch=$(date -d "$expiry_date" +%s)
        current_epoch=$(date +%s)
        days_until_expiry=$(( (expiry_epoch - current_epoch) / 86400 ))
        
        if [ $days_until_expiry -lt $THRESHOLD_DAYS ]; then
            echo "WARNING: Certificate for $domain expires in $days_until_expiry days"
            echo "Certificate for $domain expires in $days_until_expiry days" | \
                mail -s "SSL Certificate Expiration Warning" "$EMAIL"
        fi
    fi
done
```

### 📊 Renewal Logging and Alerts

#### Enhanced Logging Setup

```bash
# Configure logrotate for renewal logs
sudo nano /etc/logrotate.d/certbot-renewal
```

Logrotate configuration:

```
/var/log/certbot-renewal.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
}
```

#### Slack Integration for Alerts

```bash
# Create Slack notification function
sudo nano /usr/local/bin/slack-notify.sh
```

Slack notification script:

```bash
#!/bin/bash

WEBHOOK_URL="YOUR_SLACK_WEBHOOK_URL"
MESSAGE="$1"
STATUS="$2"

# Color coding for different statuses
case $STATUS in
    "SUCCESS") COLOR="good" ;;
    "WARNING") COLOR="warning" ;;
    "ERROR") COLOR="danger" ;;
    *) COLOR="good" ;;
esac

curl -X POST -H 'Content-type: application/json' \
    --data "{
        \"attachments\": [
            {
                \"color\": \"$COLOR\",
                \"title\": \"SSL Certificate Renewal - $STATUS\",
                \"text\": \"$MESSAGE\",
                \"footer\": \"SonarQube Server\",
                \"ts\": $(date +%s)
            }
        ]
    }" \
    "$WEBHOOK_URL"
```

### ✅ Verification Commands

```bash
# Verify automatic renewal is working
sudo certbot renew --dry-run

# Check renewal configuration
sudo certbot show_account

# List all certificates and their renewal status
sudo certbot certificates

# Check renewal configuration files
ls -la /etc/letsencrypt/renewal/

# View renewal logs
sudo tail -f /var/log/letsencrypt/letsencrypt.log
```

---

## 🆘 Troubleshooting

### Common Issues

| Problem | Solution |
|---------|----------|
| **Certificate not trusted** | Check domain DNS resolution |
| **502 Bad Gateway** | Verify SonarQube is running on port 9000 |
| **Redirect loop** | Check proxy headers configuration |
| **Certificate renewal fails** | Verify domain accessibility on port 80 |

### Diagnostic Commands

```bash
# Check NGINX configuration
sudo nginx -t

# View NGINX logs
sudo tail -f /var/log/nginx/error.log

# Check SonarQube status
sudo systemctl status sonarqube

# Test port connectivity
curl -I http://localhost:9000
```

---

## 🎯 Next Steps

After successful SSL setup:

1. 🔧 **Configure SonarQube projects** with your repositories
2. 🔗 **Set up GitHub integration** with webhook URLs
3. 📊 **Configure quality gates** for your projects
4. 🔄 **Set up CI/CD pipelines** with SonarQube integration

---

*🔒 Your SonarQube instance is now secure and ready for production use!*